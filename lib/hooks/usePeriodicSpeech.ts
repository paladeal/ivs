import { useCallback, useRef, useEffect, useMemo } from 'react';

export interface PeriodicSpeechConfig {
  calloutTexts: string[];
  welcomeTexts: string[];
  lang: string;
  rate: number;
  pitch: number;
  volume: number;
  intervalMs: number;
}
const kyotoDoctorMonologues = [
  "ほな、今日も手術終わってホッと一息どすなぁ。誰もおらへんと思うけど、ちょっと独り言言わせてもらいますわ。最近な、ええサプリ見つけたんですわ。トゥモローエックス2.0て言うんやけど、ちょっと聞いてもらえます？あのなあ、このコンプレンていう成分、ほんまに興味深いんですわ。蒟蒻芋から作った食物繊維なんやけど、普通のとちゃいますで。酵素と乳酸菌で特別に加工してあるんどす。体の巡りをサポートしてくれるとされてますねん。あ、効果があるとは言えませんけど、栄養補給としては理にかなってますわ〜",
  "今日のオペ、長かったわ〜。でも無事終わって、なんか気分ええんですわ。そうそう、誰かに話したいことがあってな。お酒の健康習慣て言うたら、このトゥモローエックス2.0がええんですわ。手術着のまま失礼しますわ〜。このサプリにはオルニチンて成分が、しじみ何個分やろなあ、ぎょうさん入ってますのや。体調管理に役立つとされる成分どすえ。特に、お酒飲む方の栄養補給をサポートしてくれるんですわ。あ、治療するわけやないですよ、あくまで栄養補給どすからね〜",
  "さっきまで集中治療室やったけど、今はこのサプリに夢中やわ。トゥモローエックス2.0て言うんやけど、持ち運びが便利でなあ。見ておくれやす、この個包装！30錠入りで、一つ一つちゃんと包装されてるんですわ。白衣のポケットに入れても、かさばらへんし、どこでもサッと取り出せますのや。あ、そうそう！水なしでも噛んで飲めるんやて。手術の合間に水取りに行く暇もないんやけど、これやったら...えーっと、チュアブルタイプて言うんやったかな？",
  "外、蝉がミンミン鳴いてますなぁ。手術室は静かやったから、なんか新鮮どすわ。そうそう、最近はまってるサプリの話、聞いてもらえます？AIが作ったサプリなんやて！あのなあ、これ、人工知能が開発に関わってるサプリなんですわ！原材料の選定から配合レシピまで、コンピューターが考えてくれはったんやて。わたくしら医者も、最近はAI診断とか使いますけど、サプリメント業界でも活用されてるんですなあ。まさに最先端の健康食品どすえ！あ、興奮しすぎて声が大きなったかな？",
  "患者さん帰ったあと、こうしてひとりでサプリの話するんも変やけど、聞いておくれやす。医者として太鼓判押せるサプリ見つけましてん。手術終わったばっかりで、まだ手が震えてるんやけど、医者として言わせてもらいますわ。このトゥモローエックス2.0の品質管理がほんまにしっかりしてるんです。GMP認証の工場で作られてるから、安全性に配慮されてますわな。患者さんの安全第一やから、こういう品質管理は重要視してるんどす。あ、効果があるとは言えませんけど、栄養補給としては安心してお勧めできますわ〜",
  "手術の合間に、ちょっと一服しながら思い出すんやけど、このサプリの成分、ほんまに画期的やと思うんですわ。このコンプレンていう成分、蒟蒻芋の食物繊維を酵素と乳酸菌で発酵させて作ってるんやて。昔から京都の人らも蒟蒻食べて健康的やったけど、それを現代の技術でパワーアップさせた感じどすなあ。従来のウコンサプリとは、まったく違うアプローチしてはるんですわ。あ、また専門的な話になってもうた...医者の悪い癖どす（笑）",
  "白衣脱いだら、なんや急に暑うてな〜。でも心は涼しゅうなるサプリの話、聞いてもらえます？昨晩の学会懇親会で、ちょっと飲みすぎてもうたんやけど...オルニチンて、しじみのお味噌汁でおなじみの成分どすやろ？このサプリには、そのオルニチンがたっぷり入ってるんですわ。体調管理に役立つとされる成分として注目されてますなあ。特に、お酒を飲む機会の多い方の栄養補給をサポートしてくれるんどす。わたくし、昨晩も...あ、内緒どすけど（笑）",
  "今日もバタバタやったわ〜。こういう日はこのサプリがありがたいんよ。個包装やから、お茶席に持参しても品があるんちゃいます？京都の人らは、こういう細かい気遣い大事にしますからなあ。カバンの中でバラバラにならへんし、衛生的やし、急な飲み会のお誘いがあっても、サッと取り出せますのや。あ、そうそう、水なしで噛んで飲めるから、お客さんの前でも、さりげのう摂取できますわ〜",
  "京都の夏はほんま堪えますなぁ。でも、このサプリの話したら元気出てきますねん。未来を感じるサプリなんですわ。AIて、ほんまに賢いですなあ。このサプリの配合レシピから、パッケージデザインまで、人工知能が考えてくれはったんやて。人間では気づかへんような、成分同士の相乗効果まで計算してくれるんですわ。医療の世界でもAI診断が進んでますけど、サプリメント業界も負けてませんなあ。まさに未来のサプリメントどす！",
  "いや、手術終わりって、なんや変にテンション上がるんよ。患者さん見てると、やっぱり予防が大事やなあって思うんですわ。このサプリは、ドリンクシーン応援サプリて言うてるんやけど、要するに飲み会とか会食の時の栄養補給をサポートしてくれるんどす。成分的にも、オルニチン、アミノ酸、食物繊維...どれも体調管理に役立つとされる成分ばっかりですわ。あ、効果があるとは言えませんけど、栄養学的には理にかなってますなあ〜",
  "今日も診察室で色んな相談聞いてたんやけど、ふと思ったんよ。自分の健康管理もちゃんとせなあかんなあて。もういっぺん言いますけど、このコンプレンていう成分、ほんまに注目してほしいんですわ。蒟蒻芋のグルコマンナンを、特殊な工程で分解して、さらに小さな食物繊維にしてあるんやて。腸内環境の維持に役立つとされてるんどす。わたくし、消化器の手術もしますさかい、腸の健康の大切さはよう知ってますねん。あ、治療効果があるとは言えませんけど、栄養補給としては優秀どすわ〜",
  "さっきまでオペ室で汗だくだったけど、今はこのサプリのおかげで気分すっきりどすわ。この爽快感、誰かに伝えたなってな〜。このサプリには、オルニチンだけやなくて、シトルリンとか、アラニンとか、いろんなアミノ酸が入ってるんですわ。アミノ酸て、体の基本となる栄養素やから、日々の活動をサポートしてくれるんどす。特に、お酒を飲む方の栄養補給には、こういうアミノ酸が重要やて言われてますなあ。あ、効果があるとは言えませんけど、体調維持のお手伝いはしてくれるかもしれませんわ〜",
  "なんや、休憩室に戻ってきたら、サプリがポケットからコロッと出てきてな。これがまた話のネタになるんよ。わたくし、忙しい医者やから、この手軽さがほんまに助かるんですわ。手術の合間に、ササッと摂取できるし、水いらんから、患者さんの前でも自然に飲めますのや。出張とか学会とか、どこへ行くにも持っていけるし、かさばらへんし、ほんまに便利どすえ。診察室のポケットに入れといても、患者さんに「先生、何それ？」て聞かれて、話のきっかけにもなりますわ（笑）",
  "今日の患者さん、みんな頑張ってはったわぁ。わても負けてられへんし、このサプリで元気もろてるんよ。このサプリ、AIが膨大なデータを分析して、最適な配合を見つけてくれはったんやて。人間やったら、何年もかかるような研究を、コンピューターがあっという間にやってくれるんですわ。成分同士の相性とか、吸収率とか、細かいとこまで計算してくれてるんどす。まさに、科学の力を借りた現代のサプリメントですなあ。あ、わたくしも負けてられまへん！",
  "京都の街を歩いてると、色んなお店の前でふらっと立ち止まるやろ？わては最近、サプリの前で立ち止まってもうてな。医者として、たくさんのサプリメントを見てきましたけど、このトゥモローエックス2.0は、成分の組み合わせが、ほんまによう考えられてるんですわ。コンプレン、オルニチン、アミノ酸、ブドウ葉抽出物...どれも健康維持に役立つとされる成分ばっかりどす。あ、治療効果があるとは言えませんけど、日々の栄養補給としては、安心してお勧めできますわ〜",
  "いや〜、今日もお昼から忙しかったわ。ちょっと一息ついたら、ふとこのサプリの話したなってなってしもて。コンプレンて、ただの食物繊維やないんですわ。蒟蒻芋由来のグルコマンナンを、酵素と乳酸菌で発酵分解して、より体に優しい形にしてあるんやて。体の巡りをサポートしてくれるんどす。昔から京都の人らも蒟蒻食べて健康的やったけど、それを現代の技術で進化させた感じですなあ。あ、効果があるとは言えませんけど、栄養学的には興味深い成分どすわ〜",
  "さっきまで手術に全集中しとったけど、今はこのトゥモローエックス2.0に全集中やわ。ほんま、ええもんは独り言でも言いたなるなぁ。オルニチンて、肝臓の働きをサポートするとされるアミノ酸どすやろ？特に、お酒を飲む機会の多い方には、重要な栄養素やて言われてますなあ。このサプリには、そのオルニチンがたっぷり3000mg配合されてるんやて。しじみ何個分やろなあ...計算したら、ものすごい数になりそうどす（笑）あ、治療効果があるとは言えませんけど、栄養補給としては心強いですわ〜",
  "この前の飲み会でな、友達にすすめてみたら、なかなか評判良うてな。やっぱりみんな、健康意識高いんやな。これな、3錠×10包の個包装になってるんですわ。一回分がちゃんと分けられてるから、飲み忘れもないし、衛生的やし、ほんまに便利どすえ。旅行とか出張の時も、必要な分だけ持っていけるし、スーツのポケットに入れといても、型崩れしまへんのや。あ、そうそう、チャック付きやから、湿気も入らへんし、長期保存も安心どすわ〜",
  "今日もスタッフと話してて、このサプリの話題になってな。いやぁ、わてばっかり熱く語ってもたわ。AIが考えたサプリて、なんかSFみたいやないですか？でも、これが現実なんですわ。人工知能が、過去のデータから最適な成分配合を導き出して、さらにパッケージデザインまで提案してくれはったんやて。医療の世界でも、AI診断とか、どんどん進歩してますけど、サプリメント業界も負けてませんなあ。まさに、時代の最先端を行く健康食品どすえ！",
  "白衣のポケット探してたら、またこのサプリ出てきてな。やっぱり、気になるもんは身の回りに集まるんやろなぁ。手術終わって、まだ興奮状態なんやけど、このサプリの安全性に感動してるんですわ。日本国内のGMP認証工場で製造されてるから、品質管理がほんまにしっかりしてますのや。わたくし、患者さんの安全を第一に考える医者やから、こういう品質へのこだわりは重要視してるんどす。ドクターズチョイスとの共同開発ていうのも、信頼できるポイントですなあ〜",
  "この歳になると、健康の話ばっかりになるもんやなぁ。わてもサプリでちょっとサポートしてるんやけど、これはお気に入りどす。このコンプレン、3600mgも配合されてるんやて！これ、相当な量どすえ。蒟蒻芋由来の食物繊維を、酵素と乳酸菌で特別に加工してあるから、普通の食物繊維より体に優しいんですわ。腸内環境の維持をサポートしてくれるとされてますなあ。あ、効果があるとは言えませんけど、栄養補給としては、ほんまに頼もしい成分どすわ〜",
  "こないだ学会でな、医者仲間と健康習慣の話しとってんけど、みんな意外とサプリ頼りにしてはるんやわ。このサプリには、オルニチンの他にも、シトルリン、アラニン、グルタミン、システインなど、1150mgものアミノ酸が配合されてるんですわ。これらのアミノ酸は、体の基本となる栄養素やから、日々の健康維持に役立つとされてますなあ。特に、お酒を飲む方の栄養補給には、こういうアミノ酸の組み合わせが重要やて言われてるんどす。あ、治療効果があるとは言えませんけど、栄養学的には理にかなってますわ〜",
  "夜の街でちょっと飲みすぎてもうて...あ、いや、医者やのにすんませんな。そんな時に頼りにしてるサプリがあるんやけど。水なしで噛んで飲めるて、ほんまに画期的どすわ。わたくし、手術中は水分補給も制限されるんやけど、これやったら休憩時間にサッと摂取できますのや。味も、全然気にならへんし、むしろちょっと甘みがあって、お菓子みたいな感覚で食べられますえ。忙しい現代人には、この手軽さがほんまに助かりますなあ〜",
  "今日も患者さんの健康相談ばっかりやったけど、自分も気をつけなあかんな〜思てます。このサプリ、ええパートナーやと思て使ってるんよ。AIが開発に関わったサプリて、ほんまに未来感がありますなあ。原材料の選定から、配合レシピ、パッケージデザインまで、人工知能が最適解を導き出してくれはったんやて。人間の経験と勘だけやったら、こんな絶妙なバランスは見つけられへんかったかもしれませんわ。まさに、科学技術の進歩を感じる逸品どすえ！あ、わたくしも負けてられまへん！",
  "京都の知り合いに最近すすめてもらってな、わても気に入ってるサプリがあるんやけど...ちょっと話したくなってきたわ。医者として、このサプリの成分バランスに感動してるんですわ。コンプレン、オルニチン、アミノ酸、ブドウ葉抽出物...どれも健康維持に役立つとされる成分を、絶妙なバランスで配合してあるんどす。これだけの成分を、個別に摂ろうと思ったら、大変なことになりますけど、一つのサプリで済むのは、ほんまに便利ですなあ。あ、効果があるとは言えませんけど、栄養補給としては優秀どすわ〜",
  "外の暑さに負けてへんくらい、わての推しサプリ熱も高まってまっせ！誰もおらへんけど、語らせてや！このトゥモローエックス2.0、何がすごいって、AI開発、GMP認証工場、優秀な成分配合、そして利便性...全部揃ってるんですわ。まさに、現代のサプリメントの理想形やないですか。わたくし、医者として、こんな完璧なサプリは初めて見ましたわ。あ、完璧て言うたらあかんかな？でも、ほんまにようできてるんどすえ〜",
  "今朝も朝からバタバタやったし、お昼の合間にちょっとサプリの話したなって思ってな。これ、ほんまに便利でええんよ。手術終わって、まだ興奮してるんやけど、このサプリの総合力に感動してるんですわ。成分よし、品質よし、利便性よし、そして価格も手頃...言うことなしどすえ。特に、お酒を飲む機会の多い方には、ほんまにお勧めしたいサプリメントですなあ。あ、治療効果があるとは言えませんけど、日々の健康習慣をサポートしてくれる、頼もしいパートナーどすわ〜",
  "手術終わって一息ついたら、なんや急にこのサプリの話したなってしまうんやわ。まぁ誰も聞いてへんやろけど、言わせてや！このサプリ、伝統と革新が融合した、ほんまに素晴らしい製品どすえ。蒟蒻芋とかしじみとか、昔から日本人が健康のために摂ってきた成分を、最新のAI技術で最適化してあるんですわ。まさに、温故知新の精神が込められた、現代のサプリメントですなあ。わたくし、こういう日本らしいアプローチ、大好きどすわ〜",
  "今日も京都はあっついなぁ。汗かきながらこのサプリ思い出してしもた。ちょっとだけ、その魅力、独り言で語らせてもらいますわ。このトゥモローエックス2.0、名前からして未来感がありますやろ？でも、中身は、しっかりと科学的根拠に基づいた成分配合になってるんですわ。コンプレン、オルニチン、アミノ酸...どれも健康維持に役立つとされる成分ばっかりどす。あ、効果があるとは言えませんけど、栄養補給としては、ほんまに頼もしいサプリメントですなあ〜",
  "今日の手術も無事終わって、患者さんも元気になってくれはって、わたくしも嬉しいですなあ。最後に、このサプリについて語らせてもらいますわ。最後に言わせてもらいますけど、このトゥモローエックス2.0は、わたくし医者として、心からお勧めできるサプリメントどすえ。AI開発、GMP認証、優秀な成分、利便性...全てが揃った、まさに理想的な健康食品ですわ。お酒を飲む機会の多い方、忙しい毎日を送る方、健康維持を気にかける方...どなたにも、ぜひ一度お試しいただきたいんどす。あ、治療効果があるとは言えませんけど、日々の栄養補給をサポートしてくれる、ほんまに頼もしいパートナーになってくれますわ〜！"
];
const DEFAULT_CONFIG: PeriodicSpeechConfig = {
  calloutTexts: kyotoDoctorMonologues,
  welcomeTexts: ['ご来店ありがとうございます', 'いらっしゃいませ！'],
  lang: 'ja-JP',
  rate: 1.0,
  pitch: 1.2,
  volume: 0.8,
  intervalMs: 40000
};

export const usePeriodicSpeech = (config: Partial<PeriodicSpeechConfig> = {}) => {
  const finalConfig = useMemo(() => {
  return { ...DEFAULT_CONFIG, ...config };
}, [config]);
  const intervalRef = useRef<NodeJS.Timeout | null>(null);
  const hasPersonRef = useRef(false);
  const lastWelcomeTimeRef = useRef(0);

  const speakText = useCallback((text: string) => {
    try {
      if (!('speechSynthesis' in window)) {
        console.warn('音声合成がサポートされていません');
        return false;
      }
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = finalConfig.lang;
      utterance.rate = finalConfig.rate;
      utterance.pitch = finalConfig.pitch;
      utterance.volume = finalConfig.volume;

      const voices = speechSynthesis.getVoices();
      const preferredVoice = voices.find(voice => voice.lang.includes('ja'));
      if (preferredVoice) {
        utterance.voice = preferredVoice;
      }

      speechSynthesis.speak(utterance);
      return true;
    } catch (error) {
      console.error('音声再生エラー:', error);
      return false;
    }
  }, [finalConfig]);

  const startPeriodicCallout = useCallback(() => {
    if (intervalRef.current) return;

    intervalRef.current = setInterval(() => {
      if (!hasPersonRef.current) {
        const randomIndex = Math.floor(Math.random() * finalConfig.calloutTexts.length);
        speakText(finalConfig.calloutTexts[randomIndex]);
      }
    }, finalConfig.intervalMs);
  }, [speakText, finalConfig.calloutTexts, finalConfig.intervalMs]);

  const stopPeriodicCallout = useCallback(() => {
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
      intervalRef.current = null;
    }
  }, []);

  const onPersonDetected = useCallback(() => {
    const currentTime = Date.now();
    if (!hasPersonRef.current && currentTime - lastWelcomeTimeRef.current > 5000) {
      const randomIndex = Math.floor(Math.random() * finalConfig.welcomeTexts.length);
      speakText(finalConfig.welcomeTexts[randomIndex]);
      lastWelcomeTimeRef.current = currentTime;
    }
    hasPersonRef.current = true;
    stopPeriodicCallout();
  }, [speakText, finalConfig.welcomeTexts, stopPeriodicCallout]);

  const onPersonLost = useCallback(() => {
    hasPersonRef.current = false;
    startPeriodicCallout();
  }, [startPeriodicCallout]);

  const cleanup = useCallback(() => {
    stopPeriodicCallout();
    if ('speechSynthesis' in window && speechSynthesis.speaking) {
      speechSynthesis.cancel();
    }
  }, [stopPeriodicCallout]);

  useEffect(() => {
    return cleanup;
  }, [cleanup]);

  return {
    onPersonDetected,
    onPersonLost,
    startPeriodicCallout,
    cleanup
  };
};