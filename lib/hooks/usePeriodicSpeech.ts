import { useCallback, useRef, useEffect, useMemo } from 'react';

export interface PeriodicSpeechConfig {
  calloutTexts: string[];
  welcomeTexts: string[];
  farewellTexts: string[];//追加
  lang: string;
  rate: number;
  pitch: number;
  volume: number;
  intervalMs: number;
}

export interface PeriodicSpeechConfig {
  calloutTexts: string[];
  welcomeTexts: string[];
  lang: string;
  rate: number;
  pitch: number;
  volume: number;
  intervalMs: number;
}
const kyotoDoctorMonologues = [
  "さて、今日も手術が終わってホッと一息ですね。誰もいないと思いますが、少し独り言を言わせてください。最近、良いサプリを見つけたんです。トゥモローエックス2.0と言うのですが、少し聞いてもらえますか？あのですね、このコンプレンという成分、本当に興味深いんですよ。こんにゃく芋から作られた食物繊維なんですが、普通のものとは違うんです。酵素と乳酸菌で特別に加工してあるんですよ。体の巡りをサポートしてくれるとされていますね。あ、効果があるとは言えませんが、栄養補給としては理にかなっていますよ。",
  "今日のオペは長かったですね。でも無事に終わって、なんだか気分が良いです。そうそう、誰かに話したいことがあって。お酒を飲む方の健康習慣と言えば、このトゥモローエックス2.0が良いんですよ。手術着のままで失礼します。このサプリにはオルニチンという成分が、しじみ何個分でしょうね、たくさん入っているんです。体調管理に役立つとされる成分ですよ。特に、お酒を飲む方の栄養補給をサポートしてくれるんです。あ、治療するわけではないですよ、あくまで栄養補給ですからね。",
  "さっきまで集中治療室にいましたが、今はこのサプリに夢中です。トゥモローエックス2.0と言うのですが、持ち運びが便利でね。見てください、この個包装！30錠入りで、一つ一つちゃんと包装されているんです。白衣のポケットに入れても、かさばらないし、どこでもサッと取り出せるんですよ。あ、そうだ！水なしでも噛んで飲めるそうです。手術の合間に水を飲みに行く時間もないのですが、これなら…ええと、チュアブルタイプと言うんでしたかね？",
  "外では蝉がミンミン鳴いていますね。手術室は静かだったので、なんだか新鮮です。そうそう、最近はまっているサプリの話、聞いてもらえますか？AIが作ったサプリだそうですよ！あのですね、これ、人工知能が開発に関わっているサプリなんです！原材料の選定から配合レシピまで、コンピューターが考えてくれたそうです。私たち医者も、最近はAI診断などを使いますが、サプリメント業界でも活用されているんですね。まさに最先端の健康食品ですよ！あ、興奮して声が大きくなってしまいましたかね？",
  "患者さんが帰った後、こうして一人でサプリの話をするのも変ですが、聞いてください。医者として太鼓判を押せるサプリを見つけたんですよ。手術が終わったばかりで、まだ手が震えていますが、医者として言わせてください。このトゥモローエックス2.0の品質管理が本当にしっかりしているんです。GMP認証の工場で作られているから、安全性に配慮されていますよね。患者さんの安全が第一ですから、こういう品質管理は重要視しているんです。あ、効果があるとは言えませんが、栄養補給としては安心してお勧めできますよ。",
  "手術の合間に、ちょっと一服しながら思い出すのですが、このサプリの成分は本当に画期的だと思います。このコンプレンという成分、こんにゃく芋の食物繊維を酵素と乳酸菌で発酵させて作っているそうです。昔から日本人もこんにゃくを食べて健康的でしたが、それを現代の技術でパワーアップさせた感じですね。従来のウコンサプリとは、全く違うアプローチをしています。あ、また専門的な話になってしまった…医者の悪い癖ですね（笑）。",
  "白衣を脱いだら、なんだか急に暑くて。でも心がすっとするサプリの話、聞いてもらえますか？昨晩の学会懇親会で、少し飲みすぎてしまったのですが…オルニチンって、しじみのお味噌汁でおなじみの成分でしょう？このサプリには、そのオルニチンがたっぷり入っているんです。体調管理に役立つとされる成分として注目されていますね。特に、お酒を飲む機会の多い方の栄養補給をサポートしてくれるんです。私も、昨晩…あ、これは内緒ですよ（笑）。",
  "今日もバタバタでした。こういう日はこのサプリがありがたいんですよ。個包装だから、持ち歩くのにも品があると思いませんか？こういう細やかな配慮は大事ですよね。カバンの中でバラバラにならないし、衛生的ですし、急な飲み会に誘われても、サッと取り出せるんです。あ、そうだ、水なしで噛んで飲めるから、人の前でもさりげなく摂取できますよ。",
  "夏の暑さは本当にこたえますね。でも、このサプリの話をすると元気が出てくるんです。未来を感じるサプリなんですよ。AIって、本当に賢いですね。このサプリの配合レシピから、パッケージデザインまで、人工知能が考えてくれたそうです。人間では気づかないような、成分同士の相乗効果まで計算してくれるんです。医療の世界でもAI診断が進んでいますが、サプリメント業界も負けていませんね。まさに未来のサプリメントです！",
  "いや、手術終わりって、なんだか妙にテンションが上がるんですよ。患者さんを見ていると、やはり予防が大事だなあと痛感します。このサプリは、ドリンクシーン応援サプリと謳っていますが、要するに飲み会や会食の時の栄養補給をサポートしてくれるんです。成分的にも、オルニチン、アミノ酸、食物繊維…どれも体調管理に役立つとされる成分ばかりです。あ、効果があるとは言えませんが、栄養学的には理にかなっていますね。",
  "今日も診察室で色々な相談を受けていたのですが、ふと思ったんですよ。自分の健康管理もちゃんとしないといけないな、と。もう一度言いますが、このコンプレンという成分、本当に注目してほしいんです。こんにゃく芋のグルコマンナンを、特殊な工程で分解して、さらに小さな食物繊維にしてあるそうです。腸内環境の維持に役立つとされているんです。私、消化器の手術もしますから、腸の健康の大切さはよく分かっているつもりです。あ、治療効果があるとは言えませんが、栄養補給としては優秀ですよ。",
  "さっきまでオペ室で汗だくでしたが、今はこのサプリのおかげで気分すっきりです。この爽快感、誰かに伝えたくなって。このサプリには、オルニチンだけでなく、シトルリンとか、アラニンとか、色々なアミノ酸が入っているんです。アミノ酸って、体の基本となる栄養素ですから、日々の活動をサポートしてくれるんです。特に、お酒を飲む方の栄養補給には、こういうアミノ酸が重要だと言われていますね。あ、効果があるとは言えませんが、体調維持のお手伝いはしてくれるかもしれません。",
  "なんだか、休憩室に戻ってきたら、サプリがポケットからコロッと出てきて。これがまた話のネタになるんですよ。私、忙しい医者なので、この手軽さが本当に助かるんです。手術の合間に、ササッと摂取できるし、水がいらないから、患者さんの前でも自然に飲めるんです。出張とか学会とか、どこへ行くにも持っていけるし、かさばらないし、本当に便利ですよ。診察室のポケットに入れておいても、患者さんに『先生、何それ？』って聞かれて、話のきっかけにもなりますしね（笑）。",
  "今日の患者さん、みんな頑張っていらっしゃいました。私も負けていられませんし、このサプリで元気をもらっています。このサプリ、AIが膨大なデータを分析して、最適な配合を見つけてくれたそうです。人間だったら、何年もかかるような研究を、コンピューターがあっという間にやってくれるんです。成分同士の相性とか、吸収率とか、細かいところまで計算してくれているんです。まさに、科学の力を借りた現代のサプリメントですね。あ、私も負けていられません！",
  "街を歩いていると、色んなお店の前でふと立ち止まるでしょう？私は最近、サプリの前で立ち止まってしまって。医者として、たくさんのサプリメントを見てきましたが、このトゥモローエックス2.0は、成分の組み合わせが、本当によく考えられているんです。コンプレン、オルニチン、アミノ酸、ブドウ葉抽出物…どれも健康維持に役立つとされる成分ばかりです。あ、治療効果があるとは言えませんが、日々の栄養補給としては、安心してお勧めできますよ。",
  "いやぁ、今日もお昼から忙しかったです。ちょっと一息ついたら、ふとこのサプリの話がしたくなってしまって。コンプレンって、ただの食物繊維じゃないんです。こんにゃく芋由来のグルコマンナンを、酵素と乳酸菌で発酵分解して、より体に優しい形にしてあるそうです。体の巡りをサポートしてくれるんですよ。昔から日本人もこんにゃくを食べて健康的でしたが、それを現代の技術で進化させた感じですね。あ、効果があるとは言えませんが、栄養学的には興味深い成分ですよ。",
  "さっきまで手術に全集中していましたが、今はこのトゥモローエックス2.0に全集中です。本当に、良いものは独り言でも言いたくなりますね。オルニチンって、肝臓の働きをサポートするとされるアミノ酸でしょう？特に、お酒を飲む機会の多い方には、重要な栄養素だと言われていますね。このサプリには、そのオルニチンがたっぷり3000mg配合されているそうです。しじみ何個分になるんでしょうね…計算したら、ものすごい数になりそうです（笑）。あ、治療効果があるとは言えませんが、栄養補給としては心強いですね。",
  "この前の飲み会で、友人にすすめてみたら、なかなか評判が良くて。やはりみんな、健康意識が高いんですね。これ、3錠×10包の個包装になっているんです。一回分がきちんと分けられているから、飲み忘れもないし、衛生的だし、本当に便利ですよ。旅行や出張の時も、必要な分だけ持っていけるし、スーツのポケットに入れておいても、型崩れしません。あ、そうだ、チャック付きだから、湿気も防げるし、長期保存も安心ですね。",
  "今日もスタッフと話していて、このサプリの話題になって。いやぁ、私ばかり熱く語ってしまいました。AIが考えたサプリって、なんだかSFみたいじゃないですか？でも、これが現実なんです。人工知能が、過去のデータから最適な成分配合を導き出して、さらにパッケージデザインまで提案してくれたそうです。医療の世界でも、AI診断とか、どんどん進歩していますが、サプリメント業界も負けていませんね。まさに、時代の最先端を行く健康食品ですよ！",
  "白衣のポケットを探っていたら、またこのサプリが出てきて。やはり、気になるものは身の回りに集まるんでしょうかね。手術が終わって、まだ興奮状態なんですが、このサプリの安全性に感動しているんです。日本国内のGMP認証工場で製造されているから、品質管理が本当にしっかりしています。私、患者さんの安全を第一に考える医者なので、こういう品質へのこだわりは重要視しているんです。ドクターズチョイスとの共同開発というのも、信頼できるポイントですね。",
  "この歳になると、健康の話ばかりになるものですね。私もサプリで少しサポートしているんですが、これはお気に入りです。このコンプレン、3600mgも配合されているそうですよ！これ、相当な量です。こんにゃく芋由来の食物繊維を、酵素と乳酸菌で特別に加工してあるから、普通の食物繊維より体に優しいんです。腸内環境の維持をサポートしてくれるとされていますね。あ、効果があるとは言えませんが、栄養補給としては、本当に頼もしい成分ですよ。",
  "この間学会で、医者仲間と健康習慣の話をしていたんですが、みんな意外とサプリに頼っているんですよね。このサプリには、オルニチンの他にも、シトルリン、アラニン、グルタミン、システインなど、1150mgものアミノ酸が配合されているんです。これらのアミノ酸は、体の基本となる栄養素ですから、日々の健康維持に役立つとされています。特に、お酒を飲む方の栄養補給には、こういうアミノ酸の組み合わせが重要だと言われているんです。あ、治療効果があるとは言えませんが、栄養学的には理にかなっていますよ。",
  "夜の街で少し飲みすぎてしまって…あ、いえ、医者なのにすみません。そんな時に頼りにしているサプリがあるんですが。水なしで噛んで飲めるって、本当に画期的ですよね。私、手術中は水分補給も制限されるんですが、これなら休憩時間にサッと摂取できるんです。味も、全然気にならないし、むしろ少し甘みがあって、お菓子みたいな感覚で食べられます。忙しい現代人には、この手軽さが本当に助かりますね。",
  "今日も患者さんの健康相談ばかりでしたが、自分も気をつけないとなと思っています。このサプリ、良いパートナーだと思って使っているんですよ。AIが開発に関わったサプリって、本当に未来感がありますね。原材料の選定から、配合レシピ、パッケージデザインまで、人工知能が最適解を導き出してくれたそうです。人間の経験と勘だけだったら、こんな絶妙なバランスは見つけられなかったかもしれません。まさに、科学技術の進歩を感じる逸品ですよ！あ、私も負けていられません！",
  "知り合いに最近すすめてもらって、私も気に入っているサプリがあるんですが…少し話したくなってきました。医者として、このサプリの成分バランスに感動しているんです。コンプレン、オルニチン、アミノ酸、ブドウ葉抽出物…どれも健康維持に役立つとされる成分を、絶妙なバランスで配合してあるんです。これだけの成分を、個別に摂ろうと思ったら、大変なことになりますけど、一つのサプリで済むのは、本当に便利ですね。あ、効果があるとは言えませんが、栄養補給としては優秀ですよ。",
  "外の暑さに負けないくらい、私の推しサプリ熱も高まっていますよ！誰もいませんが、語らせてください！このトゥモローエックス2.0、何がすごいって、AI開発、GMP認証工場、優秀な成分配合、そして利便性…全部揃っているんです。まさに、現代のサプリメントの理想形じゃないですか。私、医者として、こんな完璧なサプリは初めて見ました。あ、完璧と言ってはいけないかな？でも、本当によくできていますよ。",
  "今朝も朝からバタバタでしたし、お昼の合間に少しサプリの話がしたくなって。これ、本当に便利で良いんですよ。手術が終わって、まだ興奮していますが、このサプリの総合力に感動しているんです。成分よし、品質よし、利便性よし、そして価格も手頃…言うことなしですね。特に、お酒を飲む機会の多い方には、本当にお勧めしたいサプリメントです。あ、治療効果があるとは言えませんが、日々の健康習慣をサポートしてくれる、頼もしいパートナーですよ。",
  "手術が終わって一息つくと、なんだか急にこのサプリの話がしたくなってしまうんです。まあ誰も聞いていないでしょうけど、言わせてください！このサプリ、伝統と革新が融合した、本当に素晴らしい製品ですよ。こんにゃく芋とかしじみとか、昔から日本人が健康のために摂ってきた成分を、最新のAI技術で最適化してあるんです。まさに、温故知新の精神が込められた、現代のサプリメントですね。私、こういう日本らしいアプローチ、大好きなんですよ。",
  "今日も暑いですね。汗をかきながらこのサプリを思い出してしまいました。少しだけ、その魅力を、独り言で語らせてもらいます。このトゥモローエックス2.0、名前からして未来感があるでしょう？でも、中身は、しっかりと科学的根拠に基づいた成分配合になっているんです。コンプレン、オルニチン、アミノ酸…どれも健康維持に役立つとされる成分ばかりです。あ、効果があるとは言えませんが、栄養補給としては、本当に頼もしいサプリメントですね。",
  "今日の手術も無事終わり、患者さんも元気になってくださって、私も嬉しいです。最後に、このサプリについて語らせてもらいます。最後に言わせてもらいますが、このトゥモローエックス2.0は、私、医者として、心からお勧めできるサプリメントです。AI開発、GMP認証、優秀な成分、利便性…全てが揃った、まさに理想的な健康食品です。お酒を飲む機会の多い方、忙しい毎日を送る方、健康維持を気にかける方…どなたにも、ぜひ一度お試しいただきたいんです。あ、治療効果があるとは言えませんが、日々の栄養補給をサポートしてくれる、本当に頼もしいパートナーになってくれますよ！"
]
const DEFAULT_CONFIG: PeriodicSpeechConfig = {
  calloutTexts: kyotoDoctorMonologues,
  welcomeTexts: ['ご来店ありがとうございます', 'いらっしゃいませ！'],
  lang: 'ja-JP',
  rate: 1.0,
  pitch: 1.2,
  volume: 0.8,
  intervalMs: 5000,
  farewellTexts: ["行かないで！", "待って！！"],//追加
};

export const usePeriodicSpeech = (config: Partial<PeriodicSpeechConfig> = {}) => {
  const finalConfig = useMemo(() => {
  return { ...DEFAULT_CONFIG, ...config };
}, [config]);
  const intervalRef = useRef<NodeJS.Timeout | null>(null);
  const hasPersonRef = useRef(false);
  const lastWelcomeTimeRef = useRef(0);

  const speakText = useCallback((text: string) => {
    try {
      if (!('speechSynthesis' in window)) {
        console.warn('音声合成がサポートされていません');
        return false;
      }
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = finalConfig.lang;
      utterance.rate = finalConfig.rate;
      utterance.pitch = finalConfig.pitch;
      utterance.volume = finalConfig.volume;

      const voices = speechSynthesis.getVoices();
      const preferredVoice = voices.find(voice => voice.lang.includes('ja'));
      if (preferredVoice) {
        utterance.voice = preferredVoice;
      }

      speechSynthesis.speak(utterance);
      return true;
    } catch (error) {
      console.error('音声再生エラー:', error);
      return false;
    }
  }, [finalConfig]);

  const startPeriodicCallout = useCallback(() => {
    if (intervalRef.current) return;

    intervalRef.current = setInterval(() => {
      if (!hasPersonRef.current) {
        const randomIndex = Math.floor(Math.random() * finalConfig.calloutTexts.length);
        speakText(finalConfig.calloutTexts[randomIndex]);
      }
    }, finalConfig.intervalMs);
  }, [speakText, finalConfig.calloutTexts, finalConfig.intervalMs]);

  const stopPeriodicCallout = useCallback(() => {
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
      intervalRef.current = null;
    }
  }, []);

  const onPersonDetected = useCallback(() => {
    const currentTime = Date.now();
    if (!hasPersonRef.current && currentTime - lastWelcomeTimeRef.current > 5000) {
      const randomIndex = Math.floor(Math.random() * finalConfig.welcomeTexts.length);
      speakText(finalConfig.welcomeTexts[randomIndex]);
      lastWelcomeTimeRef.current = currentTime;
    }
    hasPersonRef.current = true;
    stopPeriodicCallout();
  }, [speakText, finalConfig.welcomeTexts, stopPeriodicCallout]);

  // const onPersonLost = useCallback(() => {
  //   hasPersonRef.current = false;
  //   startPeriodicCallout();
  // }, [startPeriodicCallout]);
  const onPersonLost = useCallback(() => {
    hasPersonRef.current = false;
    const randomIndex = Math.floor(Math.random() * finalConfig.farewellTexts.length);//追加
    speakText(finalConfig.farewellTexts[randomIndex]);//追加
    startPeriodicCallout();
  }, [startPeriodicCallout, finalConfig.farewellTexts, speakText]);

  const cleanup = useCallback(() => {
    stopPeriodicCallout();
    if ('speechSynthesis' in window && speechSynthesis.speaking) {
      speechSynthesis.cancel();
    }
  }, [stopPeriodicCallout]);

  useEffect(() => {
    return cleanup;
  }, [cleanup]);

  return {
    onPersonDetected,
    onPersonLost,
    startPeriodicCallout,
    cleanup
  };
};